# Опыт установки сервере Matrix Synapse.

Matrix — открытый протокол мгновенного обмена сообщениями. Synapse - эталонная реализация сервера для протокола.
За время использования сервера успел сделать несколько ошибок и перенести пару раз сервер с хоста на хост. Хочется поделиться своим опытом.

## Используйте для сервера Matrix отдельное доменное имя

Это даёт гибкость и, возможно, избавит вас от проблем в будущем. Если сегодня ваш сайт и сервер Matrix работают на одном сервере,
то в будущем, возможно, понадобится необходимость перенести Synapse на другую машину. Имея отдельное доменное имя можно сократить
простой работы Synapse до минимума.

Пример:
```
@ A 1.1.1.1
www A 1.1.1.1
matrix A 1.1.1.1
_matrix._tcp SRV matrix.example.com.
```

В случае необходимости вы легко можете изменив только одну запись matrix перенести сервер на другую машину. При этом сайт на основном домене может оставаться на своём месте.

## Используйте в качестве фронтэнда nginx

Это позволит упростить работу с сертификатами доменов, т.к. нет необходимости что-то прописывать в настройках synapse, использовать nginx в качестве прокси при переносе сервера synapse на другой IP адрес, т.е. уменьшить время простоя.

Если вы используете на фронтенде nginx, то нет необходимости разбираться с настройками сертификатов непосредственно в synapse, как их получать, куда их размещать. Используя nginx, вы можете использовать имеющийся опыт работы с сертификатами на других веб-серверах, либо получить этот опыт на своём Matrix-сервере и использовать его при настройке других сервисов. Получение сертификата для домена, например, с Let's Encrypt, легко автоматизируется в nginx. При этом если вы захотите перенести свой synapse на другую машину, то достаточно будет на nginx прописать настройки прокси, а сертификат необходимый у вас уже будет настроен и доступен. Нужно лишь немного изменить настройку виртуального хоста в nginx на вашей старой машине.

Пример конфигурации nginx
```nginx
server {
    listen 443 ssl http2;
    listen [aaa::aaa]:443 ssl http2 default_server;
    listen 8448 ssl default_server;
    listen [aaa::aaa]:8448 ssl default_server;

    server_name matrix.example.com;

    access_log /var/log/nginx/matrix_access.log;
    error_log /var/log/nginx/matrix_error.log;

    ssl_certificate /etc/letsencrypt/live/matrix.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/matrix.example.com/privkey.pem;

    client_max_body_size 10M;

    root /var/www/matrix/htdocs;
    index index.html;

    location /_matrix {
	      proxy_pass http://127.0.0.1:8008;
        proxy_set_header X-Forwarded-For $remote_addr;

	      # set_real_ip_from xx.xx.xx.xx;
	      # real_ip_header X-Forwarded-For;
	      # real_ip_recursive on;
    }
    include acme.conf;
}
```
В данной конфигурации производится прослушивание двух портов (443 и 8448), а также двух типов IP адресов IPv4 и IPv6. При этом по IPv4 на порту 443 кроме Matrix можут находиться другие веб-сайты. Для IPv6 для сервиса Matrix выделен отдельный адрес [aaa::aaa] (укажите свой) и другие сайты недоступны через этот порт, поэтому указан параметр default_server.

Порт 8448 используется исключительно для synapse. Для этого порта не используется SNI (Server Name Indication, с которым были проблемы в старых версиях synapse). Кроме этого, т.к. порт используется для федерации с дургими серверами Matrix, я не включаю протокол http2, на всякий случай.

В качестве server_name укажите своё доменное имя.

Файлы логов доступа и ошибок размещены в стандартном месте. Если они не нужны, укажите вместо пути значение off. Если просто закомментировать строки, то лог будет писаться в общий лог nginx.

Пути сертификату и ключу указаны стандартные для сертификатов Let's Encrypt, полученных через certbot. Эти строки необходимы для работы протокола https.

Ключ client_max_body_size указывает на максимальный размер запроса, фактически это ограничение на размер загружаемых на сервер файлов, т.к. эти запросы самые объёмные. В данном случае указано ограничение в 10 мегабайт.

Ключи root и index указывают на папку с содержимым веб-сайта и файл по умолчанию. В данном случае рассчитывается, что по данному пути будет расположен веб-клиент Riot.im. Благодаря этому подключиться к серверу через браузер можно будет просто введя адрес https://matrix.example.com/. При этом будет запущен клиент Riot.im.

Секция location обеспечивает доступ к API matrix-synapse. Закомментированные строки позволяют получить реальный IP адрес пользователя, если он был подключен через доверенный прокси по адресу xx.xx.xx.xx. Адрес клиента в этом случае берётся из заголовка X-Forwarded-For, который добавляет вышестоящий прокси, а не из IP-адреса источника. По этом причине не следует указывать адреса прокси серверов, которым вы не доверяете, поскольку они могут легко указать любой адрес или не указывать заголовок совсем. Эти же настрйки вышестоящего прокси могут быть перенесены непосредственно в секцию server, тогда они будут действовать на любые контексты на сайте matrix.example.com.

При смене IP адреса вашего matrix-synapse пропишите в настройках nginx следующее:
```nginx
    location / {
	      proxy_pass https://yy.yy.yy.yy;
	      proxy_set_header Host $host;
	      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	      proxy_set_header X-Real-IP $remote_addr;
    }
```
В качестве адреса сервера yy.yy.yy.yy необходимо указать IP адрес вашего нового сервера (не доменное имя, т.к. оно может всё ещё указывать на текущий сервер).

Последний пункт конфигурации нужен для прохождения проверки при получении нового сертификата Let's Encrypt. Содержимое файла /etc/nginx/acme.conf:
```nginx
location ~ /.well-known/acme-challenge/(.*) {
    default_type "text/plain";
    root /var/letsencrypt;
    allow all;
}
```
Папка /var/letsencrypt создана вручную и должна быть указана при создании нового сертификата как webroot, например:
```bash
certbot certonly --webroot -w /var/letsencrypt -d matrix.example.com
```
